package cve_query

import (
	"enigma/server/src/common/defs"
	cve_search "enigma/server/src/engine/cveBackend"
	"github.com/labstack/echo/v4"
	"net/http"
	"strconv"
)

func getVendorsAllHandler(c echo.Context) error {
	vendorlist, err := cve_search.GetVendorlist(G)
	if err == nil {
		return c.JSON(http.StatusOK, defs.SuccessResponse(vendorlist))
	}

	return c.JSON(http.StatusOK, defs.HttpResponse{
		Code:    defs.REST_CODE_GENERIC_FAILED,
		Msg:     "cannot get vendorlist",
		Payload: nil,
	})
}

func getVendorsPartialHandler(c echo.Context) error {
	offsetParam := c.QueryParam("offset")
	limitParam := c.QueryParam("limit")

	offset, errOffset := strconv.Atoi(offsetParam)
	limit, errLimit := strconv.Atoi(limitParam)

	isOffsetErr := len(offsetParam) == 0 || errOffset != nil || offset < 0
	isLimitErr := len(limitParam) == 0 || errLimit != nil || limit < 0

	if isOffsetErr || isLimitErr {
		return c.JSON(http.StatusOK, defs.HttpResponse{
			Code:    defs.REST_CODE_GENERIC_FAILED,
			Msg:     "offset and limit should be positive int values",
			Payload: nil,
		})
	}

	// TBD: bug here, GetVendorlist has a goroutine without any barrier
	if !cve_search.IsVendorlistInDB(G) {
		if _, err := cve_search.GetVendorlist(G); err != nil {
			return c.JSON(http.StatusOK, defs.HttpResponse{
				Code:    defs.REST_CODE_GENERIC_FAILED,
				Msg:     "cannot get vendorlist",
				Payload: nil,
			})
		}
	}

	if vendorlist, err := cve_search.GetVendorlistPartial(G, offset, limit); err == nil {
		return c.JSON(http.StatusOK, defs.SuccessResponse(vendorlist))
	}

	return c.JSON(http.StatusOK, defs.HttpResponse{
		Code:    defs.REST_CODE_GENERIC_FAILED,
		Msg:     "failed to get partial vendorlist",
		Payload: nil,
	})
}
