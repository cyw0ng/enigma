package cve_search

import (
	"bytes"
	"database/sql"
	"encoding/json"
	"enigma/server/src/common/cmds"
	"enigma/server/src/common/defs"
	"fmt"
	"html"
	"strconv"
	"strings"
	"time"
)

func GetVendorlist(G *defs.Global) (*defs.CVEBrowse, error) {
	vendorlist, err := getVendorlistFromDB(G.DBConn, 0, 0)
	if vendorlist == nil || len(vendorlist.Vendor) == 0 || err != nil {
		vendorlist, err = getVendorlistFromHTTPS()
		if err != nil {
			return nil, err
		}

		go func() {
			if insertVendorlistToDB(G.DBConn, vendorlist) != nil {
				G.Log.Error("insert vendorlist to db failed")
			} else {
				G.Log.Info("insert vendorlist to db success")
			}
		}()
	}
	return vendorlist, err
}

func GetVendorlistPartial(G *defs.Global, offset int, limit int) (*defs.CVEBrowse, error) {
	return getVendorlistFromDB(G.DBConn, offset, limit)
}

func IsVendorlistInDB(G *defs.Global) bool {
	vendorlist, err := getVendorlistFromDB(G.DBConn, 0, 0)
	notInDB := vendorlist == nil || len(vendorlist.Vendor) == 0 || err != nil

	return !notInDB
}

func insertVendorlistToDB(DBConn *sql.DB, vendorlist *defs.CVEBrowse) error {
	insertPrefix := "INSERT IGNORE INTO enigma.vendorlist (vendorName) VALUES "

	var buf bytes.Buffer

	// TBD: Fix this session, critical performance hits
	for i, vendor := range vendorlist.Vendor {
		vendor = strings.Replace(vendor, "'", "", -1)
		vendor = strings.Replace(vendor, "\"", "", -1)
		vendor = strings.Replace(vendor, "\\", "", -1)
		vendor = strings.Replace(vendor, " ", "", -1)

		buf.WriteString("('" + vendor + "'), ")
		if i != 0 && (i%2000 == 0 || i == len(vendorlist.Vendor)-1) {
			statement := insertPrefix + buf.String()
			statement = statement[0 : len(statement)-2]

			buf.Truncate(0)
			_, err := DBConn.Query(statement)
			if err != nil {
				return err
			}
		}
	}

	return nil
}

func getVendorlistFromDB(DBConn *sql.DB, offset int, limit int) (*defs.CVEBrowse, error) {
	var vendorlist *sql.Rows
	var err error
	if offset == 0 && limit == 0 {
		vendorlist, err = DBConn.Query("SELECT * FROM enigma.vendorlist;")
	} else {
		statement := fmt.Sprintf("SELECT * FROM enigma.vendorlist LIMIT %d OFFSET %d;", offset, limit)
		vendorlist, err = DBConn.Query(statement)
	}

	if err != nil {
		return nil, err
	}
	browse := &defs.CVEBrowse{
		Product: nil,
		Vendor:  nil,
	}
	for vendorlist.Next() {
		var id int
		var vendor string
		err = vendorlist.Scan(&id, &vendor)
		if err != nil {
			return nil, err
		}

		browse.Vendor = append(browse.Vendor, vendor)
	}

	return browse, nil
}

func getVendorlistFromHTTPS() (*defs.CVEBrowse, error) {
	response := cmds.CurlHttpsRequest(defs.GetVendorlistHTTPS)

	vendorlist := &defs.CVEBrowse{}

	err := json.Unmarshal([]byte(response), &vendorlist)

	if err != nil {
		return nil, err
	}

	return vendorlist, nil
}

func GetCWElist(G *defs.Global) ([]defs.CWERecord, error) {
	G.Log.Info("--> " + time.Now().String())
	cwelist, err := getCWElistFromDB(G.DBConn)
	G.Log.Info("<--" + time.Now().String())
	if cwelist == nil || len(cwelist) == 0 || err != nil {
		cwelist, err = getCWElistFromHTTPS()
		if err != nil {
			return nil, err
		}

		go func() {
			if insertCWElistToDB(G.DBConn, cwelist) != nil {
				G.Log.Error("insert cwelist to db failed")
			} else {
				G.Log.Info("insert cwelist to db success")
			}
		}()
	}
	return cwelist, err
}

func getCWElistFromDB(DBConn *sql.DB) ([]defs.CWERecord, error) {
	var cwerecords []defs.CWERecord

	var err error
	cwelist, err := DBConn.Query("SELECT cweId, description, name, relationships, status, weaknessabs FROM enigma.cwelist;")

	if err != nil {
		return nil, err
	}
	for cwelist.Next() {
		var cwerecord defs.CWERecord

		// TBD: Complete relationships
		relationships := ""
		err = cwelist.Scan(&cwerecord.ID, &cwerecord.Description, &cwerecord.Name, &relationships, &cwerecord.Status, &cwerecord.Weaknessabs)
		if err != nil {
			return nil, err
		}

		cwerecords = append(cwerecords, cwerecord)
	}

	return cwerecords, nil
}

func getCWElistFromHTTPS() ([]defs.CWERecord, error) {
	response := cmds.CurlHttpsRequest(defs.GetCWERecordHTTPS)

	var cwelist []defs.CWERecord

	err := json.Unmarshal([]byte(response), &cwelist)

	if err != nil {
		return nil, err
	}

	return cwelist, nil
}

func insertCWElistToDB(DBConn *sql.DB, cwelist []defs.CWERecord) error {
	insertPrefix := "INSERT IGNORE INTO enigma.cwelist (cweId, description, name, relationships, status, weaknessabs) VALUES "

	var buf bytes.Buffer

	// TBD: Fix this session, critical performance hits
	for i, cwe := range cwelist {
		relationships := "-"
		descriptions := html.EscapeString(cwe.Description)
		name := html.EscapeString(cwe.Name)

		buf.WriteString("(" + cwe.ID + ", '" + descriptions + "', '" + name + "', '" + relationships + "', '" + cwe.Status + "', '" + cwe.Weaknessabs + "'), ")
		if i != 0 && (i%200 == 0 || i == len(cwelist)-1) {
			statement := insertPrefix + buf.String()
			statement = statement[0 : len(statement)-2]

			buf.Truncate(0)
			_, err := DBConn.Query(statement)
			if err != nil {
				return err
			}
		}
	}

	return nil
}

func GetCapecForId(G *defs.Global, cweId int) (*defs.CapecRecord, error) {
	capecRecord, err := getCapecFromHTTPS(cweId)
	if err != nil {
		return nil, err
	}

	go func() {
		// populate relationship to DB
		err := pushRelationshipToTable(G.DBConn, cweId, capecRecord.RelatedWeakness)
		if err != nil {
			G.Log.Info(fmt.Sprintf("cannot add capec relationship record to cwe: %d", cweId))
		} else {
			G.Log.Info(fmt.Sprintf("successful to add capec relationship record to cwe: %d", cweId))
		}
	}()

	return capecRecord, err
}

func getCapecFromHTTPS(cweId int) (*defs.CapecRecord, error) {
	capecQueryUri := strings.Replace(defs.GetCapecRecordHTTPS, "capecId", strconv.Itoa(cweId), -1)
	response := cmds.CurlHttpsRequest(capecQueryUri)

	capecRecord := &defs.CapecRecord{}

	err := json.Unmarshal([]byte(response), &capecRecord)

	if err != nil {
		return nil, err
	}


	return capecRecord, nil
}

func pushRelationshipToTable(DBConn *sql.DB, cweId int, upstreamWeakness []string) error {
	query := fmt.Sprintf("SELECT relationships FROM enigma.cwelist WHERE cweId = %d;", cweId)

	queryResult, err := DBConn.Query(query)
	if err != nil {
		return err
	}

	var relationships string
	for queryResult.Next() {
		err = queryResult.Scan(&relationships)
		if err != nil {
			return err
		}
	}

	if len(relationships) == 0 || relationships[0] == '-' {
		return updateRelationshipsToDB(DBConn, cweId, upstreamWeakness)
	}

	return nil
}

func updateRelationshipsToDB(DBconn *sql.DB, cweId int, relationships []string) (error) {
	var updateRelation bytes.Buffer

	for i := 0; i < len(relationships); i++ {
		if i == len(relationships) - 1 {
			updateRelation.WriteString(relationships[i])
		} else {
			updateRelation.WriteString(relationships[i] + ",")
		}
	}

	queryString := fmt.Sprintf("UPDATE enigma.cwelist SET relationships = '%s' WHERE cweId = %d;", updateRelation.String(),cweId)

	_, err := DBconn.Query(queryString)

	return err
}